import pytest
from plans_endpoint import get_swagger


@pytest.mark.smoke
@pytest.mark.functionality
def test_swagger_response_validation(env, api, auth, level):
    """
    Test to verify the swagger call returns a 200 response and the JSON has not changed

    return: None
    """


    golden_v1beta2_swagger = {"info": {"version": "1.0", "title": "THOR-FLEET-LOGISTICS-API-V1BETA2"}, "paths": {"/plans": {"post": {"responses": {"200": {"description": "OK", "schema": {"type": "object", "properties": {"plan_id": {"type": "string", "example": "f9c16062-e866-4fb0-a720-78234d9d8d19"}, "created_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}}}}, "400": {"description": "Bad Request", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "Unable to create plan with invalid input: Expected parameter field_id is required, but none was provided."}}}}, "403": {"description": "Forbidden", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "User is not authorized to access this resource with an explicit deny."}}}}, "500": {"description": "Internal Server Error", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "Failed to create item."}}}}}, "parameters": [{"required": True, "type": "string", "name": "Authorization", "in": "header", "format": "Bearer"}, {"in": "body", "name": "Body", "schema": {"required": ["field_id", "implement_width"], "type": "object", "properties": {"field": {"type": "object", "required": ["boundary"], "properties": {"soil_type": {"type": "string", "example": "Unknown"}, "boundary": {"type": "object", "properties": {"boundary": {"items": {"type": "object", "properties": {"lat": {"type": "number"}, "lng": {"type": "number"}}}, "type": "array", "example": [{"lat": 123, "lng": 456}, {"lat": 234, "lng": 567}, {"lat": 345, "lng": 678}, {"lat": 456, "lng": 789}]}}}, "gates": {"items": {"type": "object", "properties": {"point": {"type": "object", "properties": {"lat": {"type": "number", "example": 123}, "lng": {"type": "number", "example": 456}}}}}, "type": "array"}, "reference_waylines": {"items": {"type": "object", "properties": {"lat": {"type": "number"}, "lng": {"type": "number"}}}, "type": "array", "example": [[{"lat": 20, "lng": 10}, {"lat": 30, "lng": 40}], [{"lat": 40, "lng": 50}, {"lat": 50, "lng": 60}]]}, "initial_wayline": {"items": {"type": "object", "properties": {"lat": {"type": "number"}, "lng": {"type": "number"}}}, "type": "array", "example": [{"lat": 123, "lng": 234}, {"lat": 234, "lng": 345}]}}}, "is_ctf": {"type": "boolean", "example": False}, "implement_width": {"type": "number", "example": 9.7}, "headland_width": {"type": "integer", "example": 10}, "field_id": {"type": "string", "example": "12345"}, "headland_width_optimized": {"type": "boolean", "example": False}, "constraints": {"items": {"type": "object", "properties": {"priority": {"type": "number", "example": 1}, "width": {"type": "number", "example": 10}, "turning_radius": {"type": "number", "example": 10}, "ramp_up_distance": {"type": "number", "example": 10}, "ramp_down_distance": {"type": "number", "example": 10}}}, "type": "array"}}}}], "x-amazon-apigateway-integration": {"httpMethod": "POST", "passthroughBehavior": "when_no_match", "type": "aws_proxy", "uri": "arn:aws:apigateway:eu-west-1:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-1:989451992082:function:CreatePlan_v1beta2/invocations"}, "description": "Returns a plan_id and created date", "security": [{"LambdaTokenAuthorizer": []}], "summary": "Create new plan"}}, "/plans/{plan_id}/status": {"get": {"responses": {"200": {"description": "OK", "schema": {"type": "object", "properties": {"updated_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "has_error": {"type": "boolean", "example": True}, "step_name": {"type": "string", "example": "Saved partition to S3"}, "message": {"type": "string", "example": "An error has occurred in the workflow while generating a route for the requested field. The workflow has been updated accordingly and the process terminated"}, "is_complete": {"type": "boolean", "example": True}}}}, "400": {"description": "Bad Request"}, "403": {"description": "Forbidden", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "User is not authorized to access this resource with an explicit deny."}}}}, "404": {"description": "Not Found", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "Could not find a status with the plan id f9c16062-e866-4fb0-a720-78234d9d8d19."}}}}, "500": {"description": "Internal Server Error", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "An error occurred while retrieving the statud with plan id f9c16062-e866-4fb0-a720-78234d9d8d19."}}}}, "504": {"description": "Timeout Error", "schema": {"type": "object", "properties": {"updated_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "has_error": {"type": "boolean", "example": False}, "step_name": {"type": "string", "example": "Started"}, "message": {"type": "string", "example": "An error has occurred in the workflow while generating a route for the requested field. The workflow has been updated accordingly and the process terminated"}, "is_complete": {"type": "boolean", "example": False}}}}}, "parameters": [{"required": True, "type": "string", "name": "Authorization", "in": "header", "format": "Bearer"}, {"required": True, "type": "string", "description": "UUID of the plan to get the status of.", "in": "path", "name": "plan_id"}], "x-amazon-apigateway-integration": {"httpMethod": "POST", "passthroughBehavior": "when_no_match", "type": "aws_proxy", "uri": "arn:aws:apigateway:eu-west-1:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-1:989451992082:function:GetStatus_v1beta2/invocations"}, "description": "Returns status", "security": [{"LambdaTokenAuthorizer": []}], "summary": "Retrieve the status of a plan by plan_id"}}, "/plans/{plan_id}": {"get": {"responses": {"200": {"description": "OK", "schema": {"type": "object", "properties": {"status": {"type": "object", "properties": {"updated_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "has_error": {"type": "boolean", "example": False}, "is_complete": {"type": "boolean", "example": False}, "step_name": {"type": "string", "example": "Started"}}}, "updated_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "plan_id": {"type": "string", "example": "f9c16062-e866-4fb0-a720-78234d9d8d19"}, "optimized": {"type": "boolean", "example": False}, "s3_presigned_url": {"type": "string", "example": "https://thor-fleet-logistics-partitions-stg.s3.amazonaws.com/persisted-partitions/288b241d-af50-4330-953e-84ea6617fd39-partition.json?AWSAccessKeyId=ASIA4ZHCZ7CQDSFGHEGB&Signature=qwjChWGXYnb4UCgP91VoTV2KHgY%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEDIaCXVzLWVhc3QtMSJGMEQCIChohllkih%2BI%2FN2d9cAag6xIO06m7%2BDcXrnCRG73GO5EAiAjUgy4S0H6TZvK7Zae3HsQDnfa494tSelqDJOKy4X6wSr%2BAQgbEAEaDDg3ODc5NjQ3MDQzMiIMyDSBhtXn5pIiSbH9KtsBrb5w%2BLqWYQxwIHPU%2BmjAw0gc1N3Ir5n%2Fpn1SUYJB9ufZStBYvH6qnsUz7aHICkZGv74L%2BTEYu%2B6pGk5zI5qaPJKa9hg15Ij30pGxFnYUAPXnIspdFKfRT9JyK%2BhA10HoxEU8syNo3Z4i3mJhkxE4Cqa4c5I4y1hMBeyBOCGPA2V%2Bvr2E%2FkSVGS616SJJbORRtFr605el%2BhovpNq84QBVKJxG%2FLkJd0GlufRRworuPndCJg73CTSDBgSHNtYyrtyx9hK6e854igSI7g5Ua1wu6RKlRsrzzl9ye0k6MKql8PkFOuEBhHKoQz6dA6MsN9%2FxNB32tx2HOJwiU9i%2FnPdIgXpj0lwTc3RW418bpGA7zOkYvuHb9RsbI%2FkaCf5cIJLWOJYF7z1KBqXggJj7Iq89%2BtclhkrvD%2Ba3qvWMlJZ1YdPFfwXdY2EEvtiQAB0imZrLK68xdBfSH%2FeQaEAN1x7S9OQ6ZrNuxqQDBOdlbJkDCw1RctKhMXb95e2%2B9tj0BXE4s1rDjeYsJosckU6penCcpWXh4G9hqF6241145g7M3101%2Bwm4mSJ9KdCSIWgyXiUGYLXzxO3uek9MnnyCl1zNXAWmTdnu&Expires=1597773059"}, "created_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "initial_wayline": {"items": {"type": "object", "properties": {"lat": {"type": "number"}, "lng": {"type": "number"}}}, "type": "array", "example": [{"lat": 123, "lng": 234}, {"lat": 234, "lng": 345}]}, "kpis": {"items": {"type": "object", "properties": {"name": {"type": "string"}, "result": {"type": "object", "properties": {"value": {"type": "string"}, "unit": {"type": "string"}}}}}, "type": "array", "example": [{"name": "total_wayline_length", "result": {"value": "4040.734009326736", "unit": "metres"}}, {"name": "wayline_count", "result": {"value": "1"}}, {"name": "total_area", "result": {"value": "227419.44732796913", "unit": "square metres"}}, {"name": "headland_area", "result": {"value": "39538.3054331367", "unit": "square metres"}}, {"name": "overlapped_area", "result": {"value": "1238.2548042379642", "unit": "square metres"}}, {"name": "primary_area", "result": {"value": "187881.14197863924", "unit": "square metres"}}, {"name": "perimeter", "result": {"value": "188211.7843267299", "unit": "metres"}}, {"name": "uncovered_area", "result": {"value": "188211.7843267299", "unit": "square metres"}}, {"name": "covered_area", "result": {"value": "40445.91780547719", "unit": "square metres"}}]}, "field_id": {"type": "string", "example": "67890"}}}}, "400": {"description": "Bad Request"}, "403": {"description": "Forbidden", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "User is not authorized to access this resource with an explicit deny."}}}}, "404": {"description": "Not Found", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "Could not find a plan with plan id f9c16062-e866-4fb0-a720-78234d9d8d19."}}}}, "500": {"description": "Internal Server Error", "schema": {"type": "object", "properties": {"message": {"type": "string", "example": "An error occurred while retrieving the plan with plan id f9c16062-e866-4fb0-a720-78234d9d8d19."}}}}, "504": {"description": "Timeout Error", "schema": {"type": "object", "properties": {"updated_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "status": {"type": "object", "properties": {"updated_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "has_error": {"type": "boolean", "example": True}, "step_name": {"type": "string", "example": "Saved partition to S3"}, "message": {"type": "string", "example": "An error has occurred in the workflow while generating a route for the requested field. The workflow has been updated accordingly and the process terminated"}, "is_complete": {"type": "boolean", "example": True}}}, "created_date": {"type": "string", "example": "2020-04-10T20:24:32.938Z"}, "field_id": {"type": "string", "example": "67890"}, "plan_id": {"type": "string", "example": "f9c16062-e866-4fb0-a720-78234d9d8d19"}}}}}, "parameters": [{"required": True, "type": "string", "name": "Authorization", "in": "header", "format": "Bearer"}, {"required": True, "type": "string", "description": "UUID of the plan", "in": "path", "name": "plan_id"}], "x-amazon-apigateway-integration": {"httpMethod": "POST", "passthroughBehavior": "when_no_match", "type": "aws_proxy", "uri": "arn:aws:apigateway:eu-west-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:989451992082:function:GetPlanByPlanId_v1beta2/invocations"}, "description": "Returns a plan", "security": [{"LambdaTokenAuthorizer": []}], "summary": "Retrieve a plan by plan_id"}}}, "schemes": ["https"], "basePath": "/v1beta2", "securityDefinitions": {"LambdaTokenAuthorizer": {"in": "header", "type": "apiKey", "name": "Authorization", "x-amazon-apigateway-authorizer": {"authorizerUri": "arn:aws:apigateway:eu-west-1:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-1:989451992082:function:AuthFunction_v1beta2/invocations", "authorizerResultTtlInSeconds": 300, "type": "token"}, "x-amazon-apigateway-authtype": "custom"}}, "host": "logistics.stg.agco-fuse-services.com", "definitions": {"thor_fleet_logistics_plans": {"title": "Plans", "required": ["plan_id", "field_id", "created_date", "status", "updated_date", "field", "kpis"], "type": "object", "description": "The details for a plan.", "properties": {"status": {"title": "Status", "type": "object", "description": "The status of a plan.", "properties": {"updated_date": {"type": "string", "example": "2020-07-23 19:50:43.289", "description": "The updated date of a status."}, "has_error": {"type": "boolean", "example": False, "description": "Check if the status has an error."}, "is_complete": {"type": "boolean", "example": False, "description": "Check if the status is complete."}, "step_name": {"type": "string", "example": "Generating a partition", "description": "The current step name."}}}, "updated_date": {"type": "string", "example": "2020-07-23 19:50:43.289", "description": "The updated date of a plan."}, "plan_id": {"type": "string", "example": "07e2362c-033b-4b4c-8520-900bfdc9a5e7", "description": "The plan id of a plan."}, "created_date": {"type": "string", "example": "2020-07-23 19:50:43.289", "description": "The created date of a plan."}, "initial_wayline": {"description": "The initial_wayline the user input in POST.", "type": "array", "items": {"type": "object", "properties": {"lat": {"type": "number"}, "lng": {"type": "number"}}}, "example": [{"lat": 123, "lng": 234}, {"lat": 234, "lng": 345}]}, "kpis": {"items": {"type": "object", "properties": {"name": {"type": "string", "description": "The name of the kpi calculated."}, "result": {"type": "object", "properties": {"value": {"type": "string", "description": "The value of the kpi calculated."}, "unit": {"type": "string", "description": "The unit of the kpi calculated."}}}}}, "type": "array", "description": "The wayline_count, primary_area, headland_area, total_area, overlapped_area, covered_area, uncovered_area, perimeter and total_wayline_length are calculated in the PartitionKpiProducer step.", "example": [{"name": "total_wayline_length", "result": {"value": "4040.734009326736", "unit": "metres"}}, {"name": "wayline_count", "result": {"value": "1"}}, {"name": "total_area", "result": {"value": "227419.44732796913", "unit": "square metres"}}, {"name": "headland_area", "result": {"value": "39538.3054331367", "unit": "square metres"}}, {"name": "overlapped_area", "result": {"value": "1238.2548042379642", "unit": "square metres"}}, {"name": "primary_area", "result": {"value": "187881.14197863924", "unit": "square metres"}}, {"name": "perimeter", "result": {"value": "188211.7843267299", "unit": "metres"}}, {"name": "uncovered_area", "result": {"value": "188211.7843267299", "unit": "square metres"}}, {"name": "covered_area", "result": {"value": "40445.91780547719", "unit": "square metres"}}]}, "field_id": {"type": "string", "example": "657", "description": "The field id of a plan."}}}}, "swagger": "2.0"}
    if env == 'stg':
        golden_v1beta2_swagger['host'] = golden_v1beta2_swagger['host'].replace('dev', 'stg', 1)
    elif env == 'prod':
        golden_v1beta2_swagger['host'] = golden_v1beta2_swagger['host'].replace('dev.', '', 1)
    else:
        print("No Swagger")

    response = get_swagger(env, api, auth, level)
    assert response.status_code == 200
    json_response = response.json()
    assert json_response == golden_v1beta2_swagger
